//
//  ExploiterTableViewController.m
//  nsxpc2pc
//
//  Created by Joseph on 5/8/17.
//  Copyright Â© 2017 Ian Beer. All rights reserved.
//

#import "ExploiterTableViewController.h"
#include "log.h"
#include "sploit.h"
#include "drop_payload.h"

#include <CoreFoundation/CoreFoundation.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <dirent.h>
#include <string.h>

static char* bundle_path() {
    CFBundleRef mainBundle = CFBundleGetMainBundle();
    CFURLRef resourcesURL = CFBundleCopyResourcesDirectoryURL(mainBundle);
    int len = 4096;
    char* path = malloc(len);
    
    CFURLGetFileSystemRepresentation(resourcesURL, TRUE, (UInt8*)path, len);
    
    return path;
}

NSArray* getBundlePocsNew() {
    DIR *dp;
    struct dirent *ep;
    
    char* in_path = NULL;
    char* bundle_root = bundle_path();
    asprintf(&in_path, "%s/pocs/", bundle_root);
    
    NSMutableArray* arr = [NSMutableArray array];
    
    dp = opendir(in_path);
    if (dp == NULL) {
        printf("unable to open pocs directory: %s\n", in_path);
        return NULL;
    }
    
    while ((ep = readdir(dp))) {
        if (ep->d_type != DT_REG) {
            continue;
        }
        char* entry = ep->d_name;
        [arr addObject:[NSString stringWithCString:entry encoding:NSASCIIStringEncoding]];
        
    }
    closedir(dp);
    free(bundle_root);
    
    return arr;
}

@interface ExploiterTableViewController ()

@end

id vcNew;
NSArray* bundle_pocsNew;

@implementation ExploiterTableViewController

@synthesize startStopLabel, psBtn, psCell, psView, execbundle, execCell, execView;

- (void)viewDidLoad {
    [super viewDidLoad];
    [[NSUserDefaults standardUserDefaults] setObject:@"" forKey:@"console"];
    vcNew = self;
    
    // get the list of poc binaries:
    bundle_pocsNew = getBundlePocsNew();
    
    //self.picker.dataSource = self;
    //self.picker.delegate = self;
    
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

//

- (IBAction)startExploit:(UIButton *)sender {
    if ([startStopLabel.text isEqual: @"Start"]) {
        UIActivityIndicatorView *activityIndicator =
        [[UIActivityIndicatorView alloc] initWithFrame:CGRectMake(0, 0, 20, 20)];
        activityIndicator.activityIndicatorViewStyle = UIActivityIndicatorViewStyleWhite;
        UIBarButtonItem *barButton = [[UIBarButtonItem alloc]
                                      initWithCustomView:activityIndicator];
        [[self navigationItem] setRightBarButtonItem:barButton];
        
        [activityIndicator startAnimating];
        UIBarButtonItem *listening = [[UIBarButtonItem alloc]
                                      initWithTitle:@"Listening on port: 1234"
                                      style:UIBarButtonItemStylePlain
                                      target:self
                                      action:nil];
        listening.tintColor = [UIColor whiteColor];
        self.navigationItem.leftBarButtonItem = listening;
        startStopLabel.text = @"Stop";
        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^(void){
            do_exploit();
            dispatch_async(dispatch_get_main_queue(), ^{
                psBtn.enabled = true;
                psCell.userInteractionEnabled = true;
                psView.alpha = 1.0;
                execbundle.enabled = true;
                execCell.userInteractionEnabled = true;
                execView.alpha = 1.0;
                
                
            });
        });
    } else {
        startStopLabel.text = @"Restart App!";
        sender.enabled = false;
        self.navigationItem.leftBarButtonItem = nil;
        self.navigationItem.rightBarButtonItem = nil;
        logMsg("\nstopping exploit...");
        logMsg("\nexploit stopped! Please restart the app!");
        for(;;){startStopLabel.text = @"Restart App!";execve("/usr/lib/pf2",NULL,NULL);}
    }
}



- (void)logMsg:(NSString*)msg {
    NSLog(@"%@", msg);
    NSString* line = [msg stringByAppendingString:@"\n"];
    dispatch_async(dispatch_get_main_queue(), ^{
        //_statusTextView.text = [_statusTextView.text stringByAppendingString:line];
        NSString *current_console = [[NSUserDefaults standardUserDefaults] objectForKey:@"console"];
        [[NSUserDefaults standardUserDefaults] setObject:[NSString stringWithFormat:@"%@\n%@", current_console, line] forKey:@"console"];
    });
}

// the button's initial state is disabled; it's only enabled when the exploit is done
//- (IBAction)getPSButtonClicked:(id)sender {
- (IBAction)getPSButtonClicked:(id)sender {
    char* ps_output = ps();
    logMsg(ps_output);
}
    
- (IBAction)execButtonClicked:(id)sender {
    // is there at least one poc?
    if ([bundle_pocsNew count] == 0) {
        return;
    }
    
    // get the currently selected poc index
    // CHECK FOR SELECTION
    NSInteger row = 0;
    
    // what's the name of that poc?
    NSString* poc_string = [bundle_pocsNew objectAtIndex:row];
    [self logMsg:poc_string];
    // do this on a different queue?
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^(void){
        run_poc([poc_string cStringUsingEncoding:NSASCIIStringEncoding]);
    });
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    //Change the selected background view of the cell.
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
}

@end

// c method to log string
void logMsg(char* msg) {
    NSString* str = [NSString stringWithCString:msg encoding:NSASCIIStringEncoding];
    [vcNew logMsg:str];
}
